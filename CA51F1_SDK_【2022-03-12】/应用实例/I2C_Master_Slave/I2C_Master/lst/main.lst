C51 COMPILER V9.02   MAIN                                                                  12/26/2021 22:29:12 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE source\main.c OMF2 OPTIMIZE(9,SPEED) BROWSE DEBUG PRINT(.\lst\main.lst) OBJ
                    -ECT(.\output\main.obj)

line level    source

   1          #ifndef _MAIN_C_
   2          #define _MAIN_C_
   3          /*********************************************************************************************************
             -************/
   4          #include "include/ca51f1_config.h"              
   5          #include "include/ca51f1sfr.h"
   6          #include "include/ca51f1xsfr.h"
   7          #include "include/gpiodef_f1.h"
   8          #include "include/i2c.h"
   9          #include "include/uart.h"
  10          #include "include/delay.h"
  11          #include <intrins.h>
  12          /*********************************************************************************************************
             -************/
  13          //  本例程为I2C主机从机通信的主机程序，主机读取20字节数据。  
  14          //   ____________            _____________ 
  15          //  |            |   SDA    |             |
  16          //  |            |<-------->|             |
  17          //  |            |          |             |
  18          //  |  CA51F1(M) |          | CA51F1(S)   |
  19          //  |(I2C_Master)|          | (I2C_Slave) |
  20          //  |            |   SCL    |             |
  21          //  |            |--------->|             |
  22          //  |____________|          |_____________|
  23          //
  24          /*********************************************************************************************************
             -************/
  25          #define I2C_ADDR                0xCA            //定义I2C从机地址
  26          /*********************************************************************************************************
             -************/
  27          unsigned char idata ReadBuffer[20];
  28          void main(void)
  29          {       
  30   1              unsigned char i;
  31   1      
  32   1      #ifdef LVD_RST_ENABLE
  33   1              LVDCON = 0xE0;                                  //设置LVD复位电压为2.7V
  34   1      #endif
  35   1      
  36   1      #ifdef SYSCLK_16MHZ                                     //系统时钟为16MHz,设置CKDIV为0
                      CKDIV = 0;
              #endif
  39   1      
  40   1      #ifdef UART_EN
                      Uart_Initial(UART_BAUTRATE);    //初始化UART
              #endif
  43   1              
  44   1              EA = 1;                                                 //开全局中断
  45   1      
  46   1      #ifdef PRINT_EN
                      uart_printf("I2C Master Demo Code\n");
              #endif
  49   1      
  50   1      /**********I2C端口初始化************************************************************/
C51 COMPILER V9.02   MAIN                                                                  12/26/2021 22:29:12 PAGE 2   

  51   1              P30F = P30_I2C_SDA_SETTING | PU_EN;              //设置P30作为I2C_SDA,并打开上位
  52   1              P31F = P31_I2C_SCL_SETTING | PU_EN;              //设置P31作为I2C_SCL,并打开上位
  53   1      
  54   1      /***************************************************************************************/
  55   1      
  56   1              I2CCON = I2CE(1) | I2CIE(0) | STA(0) | STP(0)| CKHD(1) | AAK(1)| CBSE(0) | STFE(1);             
  57   1              I2CADR = GCE(0);                
  58   1              I2CCR = 0x69;                                   //设置I2C时钟
  59   1              
  60   1              while(1)
  61   1              {
  62   2                      I2CCON |= STA(1);                       //I2C主机发送START信号
  63   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
  64   2                      
  65   2                      if(I2CSTA != 0x08)                              
  66   2                      {
  67   3                              I2CFLG |= I2CF;
  68   3                              goto SEND_STOP;
  69   3                      }
  70   2                      I2CDAT = I2C_ADDR;                      //主机发送从机地址+写位
  71   2                      I2CFLG |= I2CF;                         //清除中断标志
  72   2                      
  73   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
  74   2                      if(I2CSTA != 0x18)
  75   2                      {
  76   3                              I2CFLG |= I2CF;
  77   3                              goto SEND_STOP;
  78   3                      }               
  79   2                      
  80   2                      I2CDAT = 0;                                     //主机发送数据寄存器地址
  81   2                      I2CFLG |= I2CF;                         //清除中断标志
  82   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
  83   2                      if(I2CSTA != 0x28)
  84   2                      {
  85   3                              I2CFLG  |= I2CF;
  86   3                              goto SEND_STOP;
  87   3                      }
  88   2                      
  89   2                      I2CCON |= STA(1);                       //I2C主机发送START信号
  90   2                      I2CFLG  |= I2CF;                        //清除中断标志
  91   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
  92   2                      if(I2CSTA != 0x08)
  93   2                      {
  94   3                              I2CFLG  |= I2CF;
  95   3                              goto SEND_STOP;
  96   3                      }
  97   2                      
  98   2                      I2CDAT = I2C_ADDR+1;            //主机发送从机地址+读位
  99   2                      I2CFLG  |= I2CF;                        //清除中断标志
 100   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
 101   2                      if(I2CSTA != 0x40)
 102   2                      {
 103   3                              I2CFLG  |= I2CF;
 104   3                              goto SEND_STOP;
 105   3                      }
 106   2                      I2CCON |= AAK(1);                       //设置应答位
 107   2                              
 108   2                      for(i = 0; i < 20; i++)         
 109   2                      {
 110   3                              I2CFLG  |= I2CF;                //清除中断标志
 111   3                              while(!(I2CFLG & I2CF));//等待中断标志产生      
 112   3                              if((I2CSTA != 0x28)&&(I2CSTA != 0x30))
C51 COMPILER V9.02   MAIN                                                                  12/26/2021 22:29:12 PAGE 3   

 113   3                              {
 114   4                                      I2CFLG  |= I2CF;
 115   4                                      goto SEND_STOP;
 116   4                              }
 117   3                              ReadBuffer[i] = I2CDAT; //读取数据到数据寄存器
 118   3      
 119   3                              if(i == 18)
 120   3                              {
 121   4                                      I2CCON &= ~AAK(1);      
 122   4                              }
 123   3                              else
 124   3                              {
 125   4                                      I2CCON |= AAK(1);       
 126   4                              }                       
 127   3                      }
 128   2      SEND_STOP:
 129   2                      I2CCON |= STP(1);                       //发送STOP信号
 130   2                      I2CFLG  |= I2CF;
 131   2                      
 132   2                      
 133   2                      Delay_ms(100);
 134   2              }
 135   1      }
 136          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    181    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     20    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
