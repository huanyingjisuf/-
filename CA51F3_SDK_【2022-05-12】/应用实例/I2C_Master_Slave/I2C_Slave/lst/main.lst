C51 COMPILER V9.02   MAIN                                                                  10/23/2021 15:57:03 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE source\main.c OMF2 BROWSE DEBUG PRINT(.\lst\main.lst) OBJECT(.\output\ma
                    -in.obj)

line level    source

   1          
   2          #ifndef _MAIN_C_
   3          #define _MAIN_C_
   4          /*********************************************************************************************************
             -************/
   5          #include "include/ca51f_config.h"               
   6          #include "include/ca51f3sfr.h"
   7          #include "include/ca51f3xsfr.h"
   8          #include "include/gpiodef_f3.h"
   9          #include "include/system_clock.h"
  10          
  11          #include "include/uart.h"
  12          #include "include/i2c.h"
  13          #include "include/delay.h"
  14          #include <intrins.h>
  15          /*********************************************************************************************************
             -************/
  16          
  17          //  本例程为I2C主机从机通信的从机程序。
  18          //   ____________            _____________ 
  19          //  |            |   SDA    |             |
  20          //  |            |<-------->|             |
  21          //  |            |          |             |
  22          //  |  CA51F3(M) |          | CA51F3(S)   |
  23          //  |(I2C_Master)|          | (I2C_Slave) |
  24          //  |            |   SCL    |             |
  25          //  |            |--------->|             |
  26          //  |____________|          |_____________|
  27          //
  28          /*********************************************************************************************************
             -************/
  29          #define I2C_ADDR                0xCA            //定义I2C从机地址
  30          /*********************************************************************************************************
             -************/
  31          unsigned char I2CDataIndex;
  32          unsigned char regAddr;
  33          bit iicReadMode;
  34          unsigned char xdata Buffer[20]={0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19};//设置数据寄存器初值为0
             -~19
  35          void INT6_ISR(void) interrupt 11 
  36          {
  37   1              unsigned char Sta_Temp;
  38   1      
  39   1              if(I2CFLG & I2CF)                                                               //IIC  interrupt
  40   1              {                                               
  41   2                      Sta_Temp = I2CSTA;                      
  42   2                      if(Sta_Temp == 0x60)                        //接收到从机地址+写位
  43   2                      {                       
  44   3                              I2CDataIndex = 0xFF;                            //设置为0xFF表示后面接收到的第一个字节为地址
  45   3                              iicReadMode = 0;                                                //设置为从机接收状态
  46   3                              I2CCON |= AAK(1);                       
  47   3                      }
  48   2                      else if(Sta_Temp == 0x80)                       //发送或接收一字节数据，已检测到应答信号
  49   2                      {                                       
C51 COMPILER V9.02   MAIN                                                                  10/23/2021 15:57:03 PAGE 2   

  50   3                              if(iicReadMode)                                                 //发送一字节数据
  51   3                              {
  52   4                                      I2CDataIndex++;
  53   4                                      I2CDAT = Buffer[I2CDataIndex + regAddr];                        //把数据装载到发送寄存器，等待主机读取
  54   4                              }
  55   3                              else                                                                                            //接收到一字节数据
  56   3                              {                               
  57   4                                      if(I2CDataIndex == 0xFF)        //地址
  58   4                                      {
  59   5                                              regAddr = I2CDAT;                                                                                                                                       //接收到的第一个字节认为是地址
  60   5                                              I2CDataIndex = 0;                                                                                                                                       //设置索引值为0
  61   5                                              I2CCON |= AAK(1);
  62   5                                      }
  63   4                                      else                                                                            //数据
  64   4                                      {
  65   5                                              Buffer[I2CDataIndex + regAddr] = I2CDAT;                //接收到的数据装载到数据寄存器  
  66   5                                              I2CDataIndex++;                                                                                                                                         //索引值累加
  67   5                                              I2CCON |= AAK(1);               
  68   5                                      }
  69   4                              }       
  70   3                      }
  71   2                      else if(Sta_Temp==0xA8)                         //接收到从机地址+读位，发送ACK信号
  72   2                      {                                                               
  73   3                              I2CDAT = Buffer[I2CDataIndex + regAddr];                //把数据装载到发送寄存器，等待主机读取
  74   3                              iicReadMode = 1;                                                //设置为从机发送状态
  75   3                      }
  76   2                      else if(Sta_Temp == 0x88)                       //发送或接收一字节数据，已检测到应答信号
  77   2                      {
  78   3                      }
  79   2                      I2CFLG  |= I2CF;                                        //清除中断标志
  80   2              }       
  81   1      }                               
  82          void main(void)
  83          {
  84   1      #if (SYSCLK_SRC == PLL)
                      Sys_Clk_Set_PLL(PLL_Multiple);  //设置系统时钟为PLL，PLL_Multiple为倍频倍数
              #endif
  87   1              
  88   1      #ifdef UART0_EN
                      Uart0_Initial(UART0_BAUTRATE);  //初始化UART0
              #endif
  91   1              
  92   1      #ifdef UART1_EN
                      Uart1_Initial(UART1_BAUTRATE);  //初始化UART1
              #endif
  95   1      
  96   1              EA = 1;                                                                                                 //开全局中断
  97   1      
  98   1      #ifdef PRINT_EN
                      uart_printf("I2C Slave Demo Code\n");
              #endif
 101   1      
 102   1              
 103   1      
 104   1      /**********选择I2C端口************************************************************/
 105   1      //      I2CIOS = 0;
 106   1      //      P30F = P30_I2C_SDA_SETTING | PU_EN;
 107   1      //      P31F = P31_I2C_SCL_SETTING | PU_EN;             
 108   1      
 109   1              I2CIOS = 1;
 110   1              P11F = P11_I2C_SDA_SETTING | PU_EN;
 111   1              P12F = P12_I2C_SCL_SETTING | PU_EN;             
C51 COMPILER V9.02   MAIN                                                                  10/23/2021 15:57:03 PAGE 3   

 112   1      //以上两组端口二选一
 113   1      /***************************************************************************************/
 114   1      
 115   1      
 116   1              I2CCON = I2CE(1) | I2CIE(1) | STA(0) | STP(0)| CKHD(1) | AAK(1)| CBSE(0) | STFE(0);             
 117   1              I2CADR = GCE(0)|(I2C_ADDR>>1);          //设置I2C从机地址
 118   1              I2CCCR = 0x20;                                                                          //设置I2C时钟采样时钟
 119   1              INT6EN = 1;                                                                                             //I2C中断开启
 120   1      
 121   1              while(1)
 122   1              {
 123   2      
 124   2              }
 125   1      }
 126          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    161    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     20    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
