C51 COMPILER V9.02   MAIN                                                                  10/23/2021 15:56:14 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE source\main.c OMF2 BROWSE DEBUG PRINT(.\lst\main.lst) OBJECT(.\output\ma
                    -in.obj)

line level    source

   1          
   2          #ifndef _MAIN_C_
   3          #define _MAIN_C_
   4          /*********************************************************************************************************
             -************/
   5          #include "include/ca51f_config.h"               
   6          #include "include/ca51f3sfr.h"
   7          #include "include/ca51f3xsfr.h"
   8          #include "include/gpiodef_f3.h"
   9          #include "include/system_clock.h"
  10          
  11          #include "include/uart.h"
  12          #include "include/i2c.h"
  13          #include "include/delay.h"
  14          #include <intrins.h>
  15          
  16          /*********************************************************************************************************
             -************/
  17          //  本例程为I2C主机从机通信的主机程序，主机读取20字节数据。  
  18          //   ____________            _____________ 
  19          //  |            |   SDA    |             |
  20          //  |            |<-------->|             |
  21          //  |            |          |             |
  22          //  |  CA51F3(M) |          | CA51F3(S)   |
  23          //  |(I2C_Master)|          | (I2C_Slave) |
  24          //  |            |   SCL    |             |
  25          //  |            |--------->|             |
  26          //  |____________|          |_____________|
  27          //
  28          /*********************************************************************************************************
             -************/
  29          #define I2C_ADDR                0xCA            //定义I2C从机地址
  30          /*********************************************************************************************************
             -************/
  31          unsigned char xdata ReadBuffer[20];
  32          
  33          void main(void)
  34          {
  35   1              unsigned char i;
  36   1      #if (SYSCLK_SRC == PLL)
                      Sys_Clk_Set_PLL(PLL_Multiple);  //设置系统时钟为PLL，PLL_Multiple为倍频倍数
              #endif
  39   1              
  40   1      #ifdef UART0_EN
                      Uart0_Initial(UART0_BAUTRATE);  //初始化UART0
              #endif
  43   1              
  44   1      #ifdef UART1_EN
                      Uart1_Initial(UART1_BAUTRATE);  //初始化UART1
              #endif
  47   1      
  48   1              EA = 1;                                                                                                 //开全局中断
  49   1      
  50   1      #ifdef PRINT_EN
C51 COMPILER V9.02   MAIN                                                                  10/23/2021 15:56:14 PAGE 2   

                      uart_printf("I2C Master Demo Code\n");
              #endif
  53   1      
  54   1              
  55   1      
  56   1      /**********选择I2C端口************************************************************/
  57   1      //      I2CIOS = 0;
  58   1      //      P30F = P30_I2C_SDA_SETTING | PU_EN;
  59   1      //      P31F = P31_I2C_SCL_SETTING | PU_EN;             
  60   1      
  61   1              I2CIOS = 1;
  62   1              P11F = P11_I2C_SDA_SETTING | PU_EN;
  63   1              P12F = P12_I2C_SCL_SETTING | PU_EN;             
  64   1      //以上两组端口二选一
  65   1      /***************************************************************************************/
  66   1      
  67   1      
  68   1              I2CCON = I2CE(1) | I2CIE(0) | STA(0) | STP(0)| CKHD(1) | AAK(1)| CBSE(0) | STFE(1);             
  69   1              I2CADR = GCE(0);                
  70   1              I2CCCR = 0x29;                                                  //设置I2C时钟
  71   1              
  72   1              while(1)
  73   1              {
  74   2      //              Uart0_PutChar(0xaa);
  75   2                      I2CCON |= STA(1);                                       //I2C主机发送START信号
  76   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
  77   2                      
  78   2                      if(I2CSTA != 0x08)                              
  79   2                      {
  80   3                              I2CFLG  |= I2CF;
  81   3                              goto SEND_STOP;
  82   3                      }
  83   2                      I2CDAT = I2C_ADDR;                              //主机发送从机地址+写位
  84   2                      I2CFLG  |= I2CF;                                        //清除中断标志
  85   2                      
  86   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
  87   2                      if(I2CSTA != 0x18)
  88   2                      {
  89   3                              I2CFLG  |= I2CF;
  90   3                              goto SEND_STOP;
  91   3                      }               
  92   2                      
  93   2                      I2CDAT = 0;                                                             //主机发送数据寄存器地址
  94   2                      I2CFLG  |= I2CF;                                        //清除中断标志
  95   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
  96   2                      if(I2CSTA != 0x28)
  97   2                      {
  98   3                              I2CFLG  |= I2CF;
  99   3                              goto SEND_STOP;
 100   3                      }
 101   2                      
 102   2                      I2CCON |= STA(1);                                       //I2C主机发送START信号
 103   2                      I2CFLG  |= I2CF;                                        //清除中断标志
 104   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
 105   2                      if(I2CSTA != 0x08)
 106   2                      {
 107   3                              I2CFLG  |= I2CF;
 108   3                              goto SEND_STOP;
 109   3                      }
 110   2                      
 111   2                      I2CDAT = I2C_ADDR+1;                    //主机发送从机地址+读位
 112   2                      I2CFLG  |= I2CF;                                        //清除中断标志
C51 COMPILER V9.02   MAIN                                                                  10/23/2021 15:56:14 PAGE 3   

 113   2                      while(!(I2CFLG & I2CF));        //等待中断标志产生
 114   2                      if(I2CSTA != 0x40)
 115   2                      {
 116   3                              I2CFLG  |= I2CF;
 117   3                              goto SEND_STOP;
 118   3                      }
 119   2                      I2CCON |= AAK(1);                                       //设置应答位
 120   2                              
 121   2                      for(i = 0; i < 20; i++)         
 122   2                      {
 123   3                              I2CFLG  |= I2CF;                                //清除中断标志
 124   3                              while(!(I2CFLG & I2CF));//等待中断标志产生      
 125   3                              if((I2CSTA != 0x28)&&(I2CSTA != 0x30))
 126   3                              {
 127   4                                      I2CFLG  |= I2CF;
 128   4                                      goto SEND_STOP;
 129   4                              }
 130   3                              ReadBuffer[i] = I2CDAT;                 //读取数据到数据寄存器
 131   3      //                      Uart0_PutChar(ReadBuffer[i]);
 132   3                              if(i < 19)
 133   3                              {                                                                       
 134   4                                      I2CCON |= AAK(1);                       //如果不是最后一字节，预设ACK状态
 135   4                              }       
 136   3                              else
 137   3                              {                                       
 138   4                                      I2CCON &= ~AAK(1);                      //如果是最后一字节，不发送ACK   
 139   4                              }       
 140   3                      }
 141   2      SEND_STOP:
 142   2                      I2CCON |= STP(1);                               //发送STOP信号
 143   2                      I2CFLG  |= I2CF;
 144   2                      
 145   2                      
 146   2                      Delay_ms(100);
 147   2              }
 148   1      }
 149          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    194    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     20    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
