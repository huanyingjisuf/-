C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE TS_API
OBJECT MODULE PLACED IN .\hex\ts_api.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE TS_Lib\Sources\ts_api.c OMF2 OPTIMIZE(9,SIZE) BROWSE DEBUG PRINT(.\lst\ts_a
                    -pi.lst) OBJECT(.\hex\ts_api.obj)

line level    source

   1          #ifndef _TK_API_C_
   2          #define _TK_API_C_
   3          
   4          /*********************************************************************************************************
             -************/
   5          #include "ca51f_config.h"
   6          #include "includes\ca51f3sfr.h"
   7          #include "includes\ca51f3xsfr.h"
   8          #include "includes\gpiodef_f3.h"
   9          
  10          #include "Library\Includes\rtc.h"               
  11          #include "Library\Includes\system_clock.h"              
  12          #include "Library\includes\uart.h"
  13          #include "includes\system.h"
  14          #include "Library\includes\adc.h"
  15          #include "Library\includes\delay.h"
  16          #include <intrins.h>
  17          /*********************************************************************************************************
             -************/
  18          #include "TS_Lib\Includes\ts_configuration.h"
  19          #include "TS_Lib\Includes\ts_def.h"
  20          #include "TS_Lib\Includes\ts_api.h"
  21          #include "TS_Lib\Includes\ts_service.h"            
  22          /*********************************************************************************************************
             -************/
  23          void Debug_init(void);
  24          void Debug_ParamLoad(void);
  25          
  26          #if SUPPORT_KEY
  27          code unsigned int TS_KEY_CH_INFO_SEQ[][2]=
  28          {
  29                  KEY_SEQ
  30          };
  31          #endif
  32          #if SUPPORT_WHEEL_SLIDER
              code unsigned char TS_WHEEL_SLIDER_CH_SEQ[]=
              {
                      WHEEL_SLIDER0_SEQ,
              };
              code unsigned char WHEEL_SLIDER0_MAX_MIN_TAB[]={WHEEL_SLIDER0_CH_MIN_RATE};
              #else
  39          code unsigned char WHEEL_SLIDER0_MAX_MIN_TAB[1]={0};
  40          #endif  
  41          #if SUPPORT_KEY 
  42          code TYPE_SN MASK_TAB[]=
  43          {
  44                  0x000001,
  45          #if (KEY_CH_COUNT > 1)
  46                  0x000002,
  47          #endif
  48          #if (KEY_CH_COUNT > 2)
  49                  0x000004,
  50          #endif
  51          #if (KEY_CH_COUNT > 3)
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 2   

  52                  0x000008,
  53          #endif
  54          #if (KEY_CH_COUNT > 4)
  55                  0x000010,
  56          #endif
  57          #if (KEY_CH_COUNT > 5)
  58                  0x000020,
  59          #endif
  60          #if (KEY_CH_COUNT > 6)
                      0x000040,
              #endif
  63          #if (KEY_CH_COUNT > 7)
                      0x000080,
              #endif
  66          #if (KEY_CH_COUNT > 8)
                      0x000100,
              #endif
  69          #if (KEY_CH_COUNT > 9)
                      0x000200,
              #endif
  72          #if (KEY_CH_COUNT > 10)
                      0x000400,
              #endif
  75          #if (KEY_CH_COUNT > 11)
                      0x000800,
              #endif
  78          #if (KEY_CH_COUNT > 12)
                      0x001000,
              #endif
  81          #if (KEY_CH_COUNT > 13)
                      0x002000,
              #endif
  84          #if (KEY_CH_COUNT > 14)
                      0x004000,
              #endif
  87          #if (KEY_CH_COUNT > 15)
                      0x008000,
              #endif
  90          #if (KEY_CH_COUNT > 16)
                      0x010000,
              #endif
  93          #if (KEY_CH_COUNT > 17)
                      0x020000,
              #endif
  96          #if (KEY_CH_COUNT > 18)
                      0x040000,
              #endif
  99          #if (KEY_CH_COUNT > 19)
                      0x080000,
              #endif
 102          
 103          };
 104          code unsigned char AREA_CONFIRM_TIME_TAB[]=
 105          {
 106                  FINGER_TOUCH_CONFIRM_TIME,
 107                  AREA_PNOISE_PLUS_CONFIRM_TIME,
 108                  AREA_PNOISE_CONFIRM_TIME,
 109                  AREA_NNOISE_CONFIRM_TIME,
 110                  AREA_OVERLOW_CONFIRM_TIME,
 111          };
 112          #else
              code unsigned char AREA_CONFIRM_TIME_TAB[1]={0};
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 3   

              code unsigned long int MASK_TAB[1]={0};
              #endif
 116          void TS_MS_ISR (void)
 117          {
 118   1              static unsigned char xdata ms_cnt = 0;
 119   1              unsigned char i;
 120   1       
 121   1              ms_cnt++;
 122   1              if(ms_cnt >= 4)
 123   1              {
 124   2                      ms_cnt = 0;
 125   2                      for(i = 0; i < TS_Cnt; i++)
 126   2                      {
 127   3                              if(TS_AreaConfirmTimer[i])
 128   3                              {
 129   4                                      TS_AreaConfirmTimer[i]--;
 130   4                              }
 131   3                      }
 132   2      #if SUPPORT_WHEEL_SLIDER        
                              if(TSWheelSlider_TouchConfirmTimer)
                              {
                                      TSWheelSlider_TouchConfirmTimer--;
                              }
              #endif
 138   2      #if SUPPORT_KEY
 139   2      #if SUPPORT_COVER_PANAL_AFTER_POWERON
                              if(PanalCoverJudgeTimer) PanalCoverJudgeTimer--;
              #endif
 142   2      #endif
 143   2      #if SUPPORT_KEY
 144   2      #if ANTI_SPEAKER_EN
                              if(RefChDataTimer) RefChDataTimer--;
              #endif
 147   2      #endif
 148   2              }       
 149   1      }
 150          void TS_HS_ISR (void)
 151          {
 152   1      #if SUPPORT_KEY
 153   1      #if (FINGER_LONG_TOUCH_TIME_LIMIT > 0)
 154   1              unsigned char i;
 155   1      #endif
 156   1      #endif
 157   1              TS_HalfSecCnt++;
 158   1      #if SUPPORT_TOUCH_SLEEP_MODE
                      if(TS_SleepMode)
                      {
                              return;
                      }
              #endif
 164   1      #if SUPPORT_KEY
 165   1      #if (FINGER_LONG_TOUCH_TIME_LIMIT > 0)
 166   1              for(i = 0; i < KEY_CH_COUNT; i++)
 167   1              {
 168   2                      if(TSKey_LongTouchLimitTimer[i])
 169   2                      {
 170   3                              TSKey_LongTouchLimitTimer[i]--;
 171   3                      }
 172   2              }               
 173   1      #endif
 174   1      #endif
 175   1      #if SUPPORT_WHEEL_SLIDER        
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 4   

              #if (WHEEL_SLIDER_LONG_TOUCH_TIME_LIMIT > 0)
                      if(TSWheelSlider_LongTouchLimitTimer)
                      {
                              TSWheelSlider_LongTouchLimitTimer--;
                      }
              #endif
              #endif
 183   1              if(TS_RefCHBaseLineAdjuTimer)
 184   1              {
 185   2                      TS_RefCHBaseLineAdjuTimer--;
 186   2              }       
 187   1              if(EnterStopScanTimer)
 188   1              {
 189   2                      EnterStopScanTimer--;
 190   2              }       
 191   1      }
 192          void TS_ISR (void)
 193          {       
 194   1              unsigned char index_copy,i;
 195   1              WORD_UNION TS_Data[6];
 196   1              if(TLFLG & (TLERR|TLKOV|TLLOV))
 197   1              {
 198   2                      TLFLG |= TLERR|TLKOV|TLLOV;
 199   2              }
 200   1              index_copy = INDEX;
 201   1              for(i = 0; i < 6; i++)
 202   1              {
 203   2                      if(TKIF & (1<<i))
 204   2                      {
 205   3                              TKIF = (1<<i);  
 206   3                              INDEX = i;
 207   3                              TS_Data[i].bVal[0] = TKMSH;
 208   3                              TS_Data[i].bVal[1] = TKMSL;
 209   3                      }
 210   2              }
 211   1              for(i = 0; i < 6; i++)
 212   1              {
 213   2      #if (TS_ACQ_TIMES == 1)
 214   2                      TS_RawData[TS_Index+i] = TS_Data[i].wVal;
 215   2      #else
                              TS_DataSum[TS_Index+i] += TS_Data[i].wVal;      
              #endif          
 218   2                      if(TS_Index+i == TS_Cnt)
 219   2                      {                       
 220   3                              break;
 221   3                      }       
 222   2              }
 223   1              if(TS_Index+6 > TS_Cnt)
 224   1              {
 225   2      #if (TS_ACQ_TIMES == 1)
 226   2                      TS_CycleScanDoneFlag = 1;       
 227   2      #else
                              TS_Acq_Counter++;
                              if(TS_Acq_Counter >= TS_ACQ_TIMES)
                              {
                                      for(i = 0; i < TS_Cnt+1; i++)
                                      {
                                              TS_RawData[i] = TS_DataSum[i];
                                              TS_DataSum[i] = 0;
                                      }
                                      TS_CycleScanDoneFlag = 1;               
                                      TS_Acq_Counter = 0;
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 5   

                              }       
              #endif          
 240   2                      TS_Index = 0;
 241   2              }
 242   1              else 
 243   1              {
 244   2                      TS_Index += 6;
 245   2              }
 246   1              TS_ScanStart(); 
 247   1              if(TS_HalfSecCnt) TS_HalfSecCnt--;
 248   1              if(MainLoopCnt1 != MainLoopCnt2)
 249   1              {
 250   2                      MainLoopCnt2 = MainLoopCnt1;
 251   2                      WDFLG = 0xA5;
 252   2              }
 253   1              INDEX = index_copy;
 254   1      }
 255          void TS_DataFiltering(void)
 256          {
 257   1              unsigned char i;
 258   1      #if (FILTER_COUNT > 1)
 259   1              unsigned char j;
 260   1              unsigned int DataSum,DataMax,DataMin;
 261   1      #endif
 262   1              for(i = 0; i < TS_Cnt+1; i++)
 263   1              {
 264   2      #if (FILTER_COUNT == 1)
                              TS_PostData[i] = TS_RawData[i];
              #else
 267   2                      TS_FilterPosIdx[i]++;
 268   2                      if(TS_FilterPosIdx[i] >= FILTER_COUNT) 
 269   2                      {
 270   3                              TS_FilterPosIdx[i] = 0;
 271   3                      }
 272   2                      INT3EN = 0;
 273   2                      TS_FilterBuf[i][TS_FilterPosIdx[i]] = TS_RawData[i];
 274   2                      INT3EN = 1; 
 275   2                      
 276   2                      DataSum = 0;
 277   2                      DataMax = 0;
 278   2                      DataMin = 0xFFFF;
 279   2                      for(j = 0; j < FILTER_COUNT; j++)
 280   2                      {
 281   3                              DataSum += TS_FilterBuf[i][j];
 282   3      #if (FILTER_COUNT > 2)
 283   3                              if(TS_FilterBuf[i][j] > DataMax)
 284   3                              {
 285   4                                      DataMax = TS_FilterBuf[i][j];
 286   4                              }
 287   3                              if(TS_FilterBuf[i][j] < DataMin)
 288   3                              {
 289   4                                      DataMin = TS_FilterBuf[i][j];
 290   4                              }
 291   3      #endif
 292   3                      }
 293   2      #if (FILTER_COUNT == 2)
                              TS_PostData[i] = (DataSum)/(FILTER_COUNT);      
              #else
 296   2                      TS_PostData[i] = (DataSum - DataMax - DataMin)/(FILTER_COUNT-2);        
 297   2      #endif
 298   2      #endif          
 299   2              }               
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 6   

 300   1      }
 301          #if SUPPORT_KEY
 302          #if ANTI_SPEAKER_EN
              bit TS_RefChAbnormalJudge(void)
              {
                      unsigned int ref_value,crt_value,delta;
                      
                      if(RefChDataBufIdx == (REF_CH_DATA_BUF_SIZE-1)) 
                      {
                              ref_value = RefChDataBuf[0];
                      }
                      else
                      {
                              ref_value = RefChDataBuf[RefChDataBufIdx + 1];
                      }
                      crt_value = TS_PostData[OPENED_TS_COUNT];
                      if(ref_value > crt_value)
                      {
                              delta = ref_value - crt_value;
                      }
                      else
                      {
                              delta = crt_value - ref_value;
                      }
                      if(delta >= REF_CH_ABNORMAL_THD)                        
                      {
                              return 1;
                      }
                      else
                      {
                              return 0;
                      }
              }
              void TS_RefChCheck(void)
              {
                      if(!RefChDataTimer)
                      {
                              RefChDataTimer = 3;
                              RefChDataBufIdx++;
                              if(RefChDataBufIdx >= REF_CH_DATA_BUF_SIZE)
                              {
                                      RefChDataBufIdx = 0;
                              }
                              RefChDataBuf[RefChDataBufIdx] = TS_PostData[OPENED_TS_COUNT];
                      }       
              }
              #endif
 347          #endif
 348          #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 349          unsigned char GetSensAutoTrimRefCH(unsigned int *baseLine)
 350          {
 351   1              unsigned char i,idx;
 352   1              unsigned int min = 0xffff;
 353   1              for(i = 0; i < TS_Cnt; i++)
 354   1              {
 355   2                      if(baseLine[i] < min)
 356   2                      {
 357   3                              min = baseLine[i];
 358   3                              idx = i;
 359   3                      }
 360   2              }
 361   1              return idx;
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 7   

 362   1      }
 363          #endif
 364          void TS_RunInit(void)
 365          {
 366   1              unsigned char i,j;
 367   1              static unsigned char TS_ScanTimes=0;
 368   1      #if (POWER_ON_WAIT_TK_STABLE_EN)
                      static unsigned char TS_Init_Step_Sub;
              #endif
 371   1              if(TS_Init_Step == 0)
 372   1              {
 373   2      #if (TS_ACQ_TIMES > 1)
                              for(i = 0; i < TS_Cnt; i++)
                              {       
                                      TS_DataSum[i] = 0;
                              }
                              TS_Acq_Counter = 0;
              #endif
 380   2                      TS_CycleScanDoneFlag = 0;
 381   2                      TS_HalfSecCnt = 0;
 382   2                      TS_Index = 0;
 383   2                      TS_ScanStart(); 
 384   2      #if POWER_ON_WAIT_TK_STABLE_EN
                              TS_Init_Step = 1;               
                              TS_Init_Step_Sub = 0;
                              TS_ScanTimes = 5;
              #else
 389   2                      TS_Init_Step = 2;
 390   2                      TS_ScanTimes = 50;                      
 391   2      #endif
 392   2              }
 393   1      #if POWER_ON_WAIT_TK_STABLE_EN
                      else if(TS_Init_Step == 1)
                      {
                              if(TS_CycleScanDoneFlag)
                              {
                                      TS_CycleScanDoneFlag = 0;
                                      if(TS_Init_Step_Sub == 0)
                                      {
                                              if(--TS_ScanTimes)
                                              {                               
                                                      return;
                                              }
                                              for(i = 0; i < TS_Cnt+1; i++)
                                              {
                                                      TS_PostData[i] = TS_RawData[i];
                                              }
                                              TS_Init_Step_Sub = 1;
                                              TS_AreaConfirmTimer[0] = 40;
                                      }                       
                                      else if(TS_Init_Step_Sub == 1)
                                      {
                                              if(!TS_AreaConfirmTimer[0])
                                              {
                                                      int delta;
                                                      for(i = 0; i < TS_Cnt+1; i++)
                                                      {
                                                              delta = (int)TS_PostData[i] - (int)TS_RawData[i];
                                                              if((delta > NOISE_THRESHOLD) || (delta < -NOISE_THRESHOLD))
                                                              {
                                                                      TS_Init_Step_Sub = 0;
                                                                      return;
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 8   

                                                              }
                                                      }                       
                                                      TS_Init_Step = 2;
                                                      TS_ScanTimes = 10;      
                                              }
                                      }
                              }
                      }
              #endif
 433   1              else if(TS_Init_Step == 2)
 434   1              {
 435   2                      if(TS_CycleScanDoneFlag)
 436   2                      {
 437   3                              TS_CycleScanDoneFlag = 0;
 438   3                              if(--TS_ScanTimes)
 439   3                              {                               
 440   4                                      return;
 441   4                              }
 442   3                              TS_RefCHBaseLineAdjuTimer = 0;
 443   3                              for(i = 0; i < TS_Cnt+1; i++)
 444   3                              {       
 445   4                                      for(j = 0; j < FILTER_COUNT; j++)
 446   4                                      {
 447   5                                              TS_FilterBuf[i][j] = TS_RawData[i];
 448   5                                      }
 449   4                                      TS_FilterPosIdx[i] = 0;
 450   4                                      
 451   4                                      if(i == TS_Cnt) break;
 452   4                                      TS_BaseLineData[i] = TS_RawData[i];                     
 453   4                                      TS_FirstAreaData[i] = TS_RawData[i]; 
 454   4      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 455   4                                      TS_PostData2[i] = TS_RawData[i];
 456   4      #endif                          
 457   4      #if TK_BASE_TRIM_WHILE_KEY_PRESSED
 458   4                                      RefChDataBak[i] = TS_RawData[OPENED_TS_COUNT];
 459   4                                      TS_BaseLineDataBak[i] = TS_BaseLineData[i];
 460   4      #endif                                  
 461   4                                      
 462   4      #if (SUPPORT_KEY && SUPPORT_WHEEL_SLIDER)
                                              if(i < KEY_CH_COUNT)
                                              {
              #if TK_SENSITIVE_AUTO_TRIM_EN
                                                      TK_TouchThdTrim(i);
              #else
                                                      TSKey_FingerThd[i] = TS_KEY_CH_INFO_SEQ[i][1];
              #endif
                                                      TS_AreaConfirmTimerSet(i,AREA_PNOISE);
                                              }
                                              else
                                              {
                                                      TS_AreaConfirmTimer[i] = WHEEL_SLIDER_BASELINE_UPDATE_TIME;
                                              }
              #elif SUPPORT_KEY
 477   4                                      TSKey_FingerThd[i] = TS_KEY_CH_INFO_SEQ[i][1];
 478   4                                      TS_AreaConfirmTimerSet(i,AREA_PNOISE);                          
 479   4      #elif SUPPORT_WHEEL_SLIDER
                                              TS_AreaConfirmTimer[i] = WHEEL_SLIDER_BASELINE_UPDATE_TIME;
              #endif
 482   4                              }       
 483   3      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 484   3                              SensAutoTrimRefCH = GetSensAutoTrimRefCH(TS_BaseLineData);
 485   3      #endif
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 9   

 486   3      #if SUPPORT_KEY
 487   3      #if ANTI_SPEAKER_EN
                                      for(i = 0; i < REF_CH_DATA_BUF_SIZE; i++)
                                      {
                                              RefChDataBuf[i] = TS_PostData[OPENED_TS_COUNT];
                                      }
                                      RefChDataBufIdx = 0;
              #endif          
 494   3      #endif                  
 495   3      #if (DEBUG)
                                      Debug_ParamLoad();
              #endif          
 498   3                              TS_State = TS_DEAL;     
 499   3                      }
 500   2              }
 501   1      }
 502          #if SUPPORT_KEY
 503          #if SUPPORT_ANTI_WATER_FUNCTION
              unsigned char AntiWaterModeGetMaxDeltaCh(void)
              {
                      unsigned char i;
                      unsigned long int CalcTemp1;
                      unsigned int CalcTemp2,CalcTemp3;
                      int Delta;
                      int max_delta;
                      char max_index;
                      max_delta = 0;
                      for(i = 0; i < KEY_CH_COUNT; i++)
                      {
                              if(i == 0)
                              {
                                      Delta = (int)TS_BaseLineData[i] - (int)TS_PostData[i];
                              }
                              else
                              {
                                      CalcTemp1 =     (unsigned long int)TS_PostData[i] * (unsigned long int)TS_BaseLineData[0];
                                      CalcTemp2 =     (unsigned int)(CalcTemp1/TS_BaseLineData[i]);
                                      CalcTemp3 =     TS_PostData[i] + TS_BaseLineData[0] - CalcTemp2;
                                      CalcTemp2 =     (unsigned int)(CalcTemp1/CalcTemp3);    
                                      Delta           =       (int)TS_BaseLineData[0] - (int)CalcTemp2;                                               
                              }
                              if(max_delta < Delta)
                              {
                                      max_delta = Delta;
                                      max_index = i;
                              }
                      }
                      return max_index;
              }
              #endif
 536          #endif
 537          #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 538          int GetTouchDiffer(unsigned int touchData,unsigned int touchBase,unsigned int baseRef)
 539          {
 540   1              unsigned long int CalcTemp1;
 541   1              unsigned int CalcTemp2,CalcTemp3;
 542   1              int Delta;
 543   1      
 544   1              CalcTemp1 =     (unsigned long int)touchData * (unsigned long int)baseRef;
 545   1              CalcTemp2 =     (unsigned int)(CalcTemp1/touchBase);
 546   1              CalcTemp3 =     touchData + baseRef - CalcTemp2;
 547   1              CalcTemp2 =     (unsigned int)(CalcTemp1/CalcTemp3);    
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 10  

 548   1              Delta           =       (int)baseRef - (int)CalcTemp2;                                          
 549   1      
 550   1              return Delta;
 551   1      }
 552          #endif
 553          #if SUPPORT_KEY
 554          void TSKey_DataDeal(void)
 555          {
 556   1              unsigned char i;
 557   1              unsigned char  TouchArea,NowArea;               
 558   1      
 559   1      #if SUPPORT_COVER_PANAL_AFTER_POWERON
                      unsigned char PanalToggleCount = 0;
              #endif
 562   1              for(i = 0; i < KEY_CH_COUNT; i++)
 563   1              {       
 564   2      #if SUPPORT_ANTI_WATER_FUNCTION
                              if(KeyPressedFlag)
                              {
                                      if(PressedKeyIndex != i)
                                      {
              #if TK_BASE_TRIM_WHILE_KEY_PRESSED                                      
                                              TS_BaseLineData[i] = ((unsigned long int)TS_BaseLineDataBak[i]*TS_PostData[OPENED_TS_COUNT])/RefChData
             -Bak[i];
              #endif          
                                              TS_FirstAreaData[i] = TS_BaseLineData[i];
                                              TS_AreaConfirmTimerSet(i,AREA_PNOISE);          
                                              continue;               
                                      }
                              }
              #endif
 578   2      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 579   2                      if(SensAutoTrimRefCH == i)
 580   2                      {
 581   3                              TS_PostData2[i] = TS_PostData[i];
 582   3                      }
 583   2                      else
 584   2                      {
 585   3                              TS_PostData2[i] = (int)TS_BaseLineData[i] - GetTouchDiffer(TS_PostData[i],TS_BaseLineData[i],TS_BaseLin
             -eData[SensAutoTrimRefCH]);
 586   3                      }
 587   2      #endif
 588   2                      TouchArea = TS_GetDataArea(i,TS_FirstAreaData[i],NOISE_THRESHOLD,(bit)(PreKeysFlagSN & MASK_TAB[i]));
 589   2      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 590   2                      NowArea   = TS_GetDataArea(i,TS_PostData2[i],NOISE_THRESHOLD,(bit)(PreKeysFlagSN & MASK_TAB[i]));
 591   2      #else
                              NowArea   = TS_GetDataArea(i,TS_PostData[i],NOISE_THRESHOLD,(bit)(PreKeysFlagSN & MASK_TAB[i]));
              #endif
 594   2                      
 595   2                      if((NowArea != AREA_PNOISE)&&(NowArea != AREA_NNOISE))
 596   2                      {
 597   3                              TS_StableFlag = 0;              
 598   3                      }
 599   2      #if SUPPORT_COVER_PANAL_AFTER_POWERON
                              if((NowArea == AREA_PNOISE_PLUS) || (NowArea == AREA_FINGER_TOUCH))
                              {
                                      PanalToggleCount++;
                              }
              #endif
 605   2                      if(TouchArea == AREA_FINGER_TOUCH)
 606   2                      {
 607   3                              if(NowArea == AREA_FINGER_TOUCH)
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 11  

 608   3                              {
 609   4                                      if(!(PreKeysFlagSN & MASK_TAB[i]))
 610   4                                      {
 611   5                                              if(!TS_AreaConfirmTimer[i])
 612   5                                              {               
 613   6                                                      PreKeysFlagSN |= MASK_TAB[i];           
 614   6      #if (FINGER_LONG_TOUCH_TIME_LIMIT > 0)
 615   6                                                      TSKey_LongTouchLimitTimer[i] = FINGER_LONG_TOUCH_TIME_LIMIT;
 616   6      #endif
 617   6                                                      TS_AreaConfirmTimer[i] = FINGER_TOUCH_RELEASE_CONFIRM_TIME;     
 618   6                                              }
 619   5                                      }
 620   4                                      else
 621   4                                      {       
 622   5      #if SUPPORT_ANTI_WATER_FUNCTION         
                                                      if(i != AntiWaterModeGetMaxDeltaCh())
                                                      {
                                                              goto ANTI_WATER_MODE_KEY_RELEASE;
                                                      }
              #endif
 628   5      #if TK_BASE_TRIM_WHILE_KEY_PRESSED                                      
 629   5                                              TS_BaseLineData[i] = ((unsigned long int)TS_BaseLineDataBak[i]*TS_PostData[OPENED_TS_COUNT])/RefChDat
             -aBak[i];
 630   5      #endif          
 631   5                                              TS_AreaConfirmTimer[i] = FINGER_TOUCH_RELEASE_CONFIRM_TIME;
 632   5      #if (FINGER_LONG_TOUCH_TIME_LIMIT > 0)
 633   5                                              if(!TSKey_LongTouchLimitTimer[i])
 634   5                                              {
 635   6                                                      PreKeysFlagSN &= ~MASK_TAB[i];
 636   6                                                      TS_FirstAreaData[i] = TS_PostData[i];
 637   6                                                      TS_BaseLineData[i]      = TS_PostData[i];
 638   6                                                      TS_AreaConfirmTimerSet(i,AREA_PNOISE);          
 639   6      #if SUPPORT_ANTI_WATER_FUNCTION
                                                              KeyPressedFlag = 0;
                                                              break;
              #endif                                          
 643   6                                              }                                                       
 644   5      #endif                                  
 645   5                                      }                               
 646   4                              }
 647   3                              else
 648   3                              {
 649   4                                      if(PreKeysFlagSN & MASK_TAB[i]) 
 650   4                                      {
 651   5                                              if(!TS_AreaConfirmTimer[i])
 652   5                                              {
 653   6      #if SUPPORT_ANTI_WATER_FUNCTION
              ANTI_WATER_MODE_KEY_RELEASE:                                            
                                                              KeyPressedFlag = 0;
              #endif
 657   6                                                      PreKeysFlagSN &= ~MASK_TAB[i];
 658   6      
 659   6                                                      TS_FirstAreaData[i] = TS_BaseLineData[i];
 660   6                                                      TS_AreaConfirmTimerSet(i,AREA_PNOISE);
 661   6      #if SUPPORT_ANTI_WATER_FUNCTION
                                                              break;
              #endif
 664   6                                              }                                       
 665   5                                      }                       
 666   4                                      else
 667   4                                      {
 668   5      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 12  

 669   5                                              TS_FirstAreaData[i] = TS_PostData2[i];
 670   5      #else
                                                      TS_FirstAreaData[i] = TS_PostData[i];
              #endif
 673   5                                              TS_AreaConfirmTimerSet(i,NowArea);
 674   5                                      }       
 675   4                              }       
 676   3                              continue;                                               
 677   3                      }       
 678   2                      else
 679   2                      {
 680   3                              if(NowArea == AREA_FINGER_TOUCH)
 681   3                              {
 682   4      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 683   4                                      TS_FirstAreaData[i] = TS_PostData2[i];
 684   4      #else
                                              TS_FirstAreaData[i] = TS_PostData[i];
              #endif
 687   4                                      TS_AreaConfirmTimerSet(i,AREA_FINGER_TOUCH);
 688   4                                      continue;               
 689   4                              }       
 690   3                      }
 691   2                      if(PreKeysFlagSN != 0) 
 692   2                      {
 693   3                              TS_FirstAreaData[i] = TS_BaseLineData[i];
 694   3                              TS_AreaConfirmTimerSet(i,AREA_PNOISE);          
 695   3                              continue;                       
 696   3                      }
 697   2      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 698   2                      if(TS_AreaDeviateDetection(TS_FirstAreaData[i],TS_PostData2[i],NOISE_THRESHOLD))           //ÅÐ¶ÏÆ«²îÊÇ·ñÔÚÔÊÐí
             -·¶Î§ÄÚ
 699   2      #else
                              if(TS_AreaDeviateDetection(TS_FirstAreaData[i],TS_PostData[i],NOISE_THRESHOLD))    //ÅÐ¶ÏÆ«²îÊÇ·ñÔÚÔÊÐí·
             -¶Î§ÄÚ
              #endif
 702   2                      {       
 703   3                              if(!TS_AreaConfirmTimer[i])
 704   3                              {
 705   4                                      TS_FirstAreaData[i] = TS_PostData[i];
 706   4                                      TS_BaseLineData[i]      = TS_PostData[i];
 707   4      #if TK_BASE_TRIM_WHILE_KEY_PRESSED
 708   4                                      RefChDataBak[i] = TS_PostData[OPENED_TS_COUNT];
 709   4                                      TS_BaseLineDataBak[i] = TS_BaseLineData[i];
 710   4      #endif                          
 711   4                                      TS_AreaConfirmTimerSet(i,AREA_PNOISE);  
 712   4                              }       
 713   3                      }
 714   2                      else
 715   2                      {
 716   3      #if TOUCH_SENSITIVITY_AUTO_BALANCE_EN
 717   3                              TS_FirstAreaData[i] = TS_PostData2[i];  
 718   3      #else
                                      TS_FirstAreaData[i] = TS_PostData[i];   
              #endif
 721   3                              TS_AreaConfirmTimerSet(i,NowArea);              
 722   3                      }
 723   2              }               
 724   1      #if SUPPORT_ANTI_WATER_FUNCTION
                      if(KeysFlagSN == 0)
                      {
                              if(PreKeysFlagSN != 0)
                              {
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 13  

                                      PressedKeyIndex = AntiWaterModeGetMaxDeltaCh();
                                      PreKeysFlagSN = MASK_TAB[PressedKeyIndex];
              #if (FINGER_LONG_TOUCH_TIME_LIMIT > 0)
                                      TSKey_LongTouchLimitTimer[PressedKeyIndex] = FINGER_LONG_TOUCH_TIME_LIMIT;
              #endif
                                      TS_AreaConfirmTimer[PressedKeyIndex] = FINGER_TOUCH_RELEASE_CONFIRM_TIME;       
                                      KeyPressedFlag = 1;
                              }
                      }
              #endif
 739   1      #if SUPPORT_COVER_PANAL_AFTER_POWERON
                      if(!PanalCoverJudgeFlag)
                      {
                              if(PreKeysFlagSN != 0)
                              {
                                      if(KeysFlagSN == 0)
                                      {
                                              PanalCoverJudgeFlag = 1;
                                              PanalCoverJudgeTimer = PANAL_COVER_JUDGE_TIME;          
                                      }
                                      else
                                      {
                                              if((PanalToggleCount >= JUDGE_TK_NUM)||(TS_RefChAbnormalJudge()))
                                              {
                                                      PreKeysFlagSN = 0;
                                                      PanalCoverJudgeFlag = 0;
                                                      TS_BaseLineForceUpdate();
                                              }
                                              KeysFlagSN  = PreKeysFlagSN;
                                      }
                              }
                              else
                              {
                                      KeysFlagSN  = PreKeysFlagSN;
                              }
                      }
                      else
                      {
                              if(!PanalCoverJudgeTimer)
                              {
                                      PanalCoverJudgeFlag = 0;
                                      KeysFlagSN = PreKeysFlagSN;
                              }
                              else
                              {
                                      if((PanalToggleCount >= JUDGE_TK_NUM)||(TS_RefChAbnormalJudge()))
                                      {
                                              PreKeysFlagSN = 0;
                                              PanalCoverJudgeFlag = 0;
                                              TS_BaseLineForceUpdate();
                                      }                       
                              }
                      }
              #else
 783   1      #if ANTI_SPEAKER_EN
                      if((PreKeysFlagSN != 0)&&(KeysFlagSN == 0))
                      {
                              if(TS_RefChAbnormalJudge())
                              {
                                      PreKeysFlagSN = 0;
                                      
              #if SUPPORT_ANTI_WATER_FUNCTION
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 14  

                                      KeyPressedFlag = 0;
              #endif
                                      TS_BaseLineForceUpdate();               
                              }
                      }
              #endif
 797   1              KeysFlagSN  = PreKeysFlagSN;
 798   1      
 799   1      #endif
 800   1              if(KeysFlagSN != 0) 
 801   1              {
 802   2                      ActiveTouchType = 1;
 803   2              }
 804   1              else
 805   1              {
 806   2                      ActiveTouchType = 0;
 807   2              }
 808   1      }
 809          #endif
 810          #if SUPPORT_WHEEL_SLIDER
              void TS_WheelSliderDeal(void)
              {
                      unsigned char i;
                      unsigned int   Delta,Position;
                      bit WheelSliderTogFlag = 0;
                      TS_BaseCh = KEY_CH_COUNT; 
                      if(!W_S_RefChSet)
                      {
                              W_S_RefChSet = 1;               
                              SetWheelSliderRefCh(WHEEL_SLIDER0_CH_COUNT);
                      }
                      
              #if PRINT_WHEEL_SLIDER_DATA_EN
                      TK_Debug_UartPutChar(0xaa);
                      for(i = TS_BaseCh; i < TS_BaseCh + WHEEL_SLIDER0_CH_COUNT; i++)
                      {                                               
                              if(TS_BaseLineData[i] > TS_PostData[i])
                              {
                                      Delta = (int)TS_BaseLineData[i] - (int)TS_PostData[i];  
                              }
                              else
                              {
                                      Delta = 0;
                              }                                               
                              TK_Debug_UartPutChar(i);
                              TK_Debug_UartPutChar(TS_PostData[i]>>8);
                              TK_Debug_UartPutChar(TS_PostData[i]);                   
                              TK_Debug_UartPutChar(TS_BaseLineData[i]>>8);
                              TK_Debug_UartPutChar(TS_BaseLineData[i]);       
                              TK_Debug_UartPutChar(Delta>>8); 
                              TK_Debug_UartPutChar(Delta);                                                            
                      }                               
              #endif
              #if (WHEEL_OR_SLIDER_DEF0       == SLIDER)
                      Position = SliderTouchJudge(WHEEL_SLIDER0_CH_COUNT,WHEEL_SLIDER0_TOUCH_THD);
              #elif (WHEEL_OR_SLIDER_DEF0     == WHEEL)
                      Position = WheelTouchJudge(WHEEL_SLIDER0_CH_COUNT,WHEEL_SLIDER0_TOUCH_THD);
              #endif
                      if(Position != -1)
                      {
                              TS_StableFlag = 0;
                      }
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 15  

                      if(WheelSliderState == WHEEL_SLIDER_NO_TOUCH)
                      {
                              if(!WheelSliderTouchFlag)
                              {
                                      if(Position != -1)
                                      {
                                              WheelSliderTouchFlag = 1;       
                                              TSWheelSlider_TouchConfirmTimer = WHEEL_SLIDER_TOUCH_CONFIRM_TIME;                              
                                      }
                                      else
                                      {
                                              for(i = TS_BaseCh; i < TS_BaseCh + WHEEL_SLIDER0_CH_COUNT; i++)
                                              {                                               
                                                      if(TS_FirstAreaData[i] > TS_PostData[i]) 
                                                      {
                                                              Delta   = TS_FirstAreaData[i] - TS_PostData[i];
                                                      }
                                                      else
                                                      {
                                                              Delta   = TS_PostData[i] - TS_FirstAreaData[i];
                                                      }                                       
                                                      if(Delta <= WHEEL_SLIDER0_NOISE_THD) 
                                                      {
                                                              if(!TS_AreaConfirmTimer[i])
                                                              {
                                                                      TS_FirstAreaData[i] = TS_PostData[i];
                                                                      TS_BaseLineData[i]      = TS_PostData[i];
                                                                      TS_AreaConfirmTimer[i] = WHEEL_SLIDER_BASELINE_UPDATE_TIME;
                                                              }                                                       
                                                      }
                                                      else
                                                      {
                                                              TS_FirstAreaData[i] = TS_PostData[i];
                                                              TS_AreaConfirmTimer[i] = WHEEL_SLIDER_BASELINE_UPDATE_TIME;
                                                      }
                                              }
                                      }                       
                              }       
                              else
                              {       
                                      if(Position != -1)
                                      {
                                              if(!TSWheelSlider_TouchConfirmTimer)
                                              {
                                                              WheelSliderState = WHEEL_SLIDER_TOUCH;  
              #if (WHEEL_SLIDER_LONG_TOUCH_TIME_LIMIT > 0)
                                                              TSWheelSlider_LongTouchLimitTimer = WHEEL_SLIDER_LONG_TOUCH_TIME_LIMIT;
              #endif
                                              }       
                                      }
                                      else
                                      {
                                              WheelSliderTouchFlag = 0;
                                              for(i = TS_BaseCh; i < TS_BaseCh + WHEEL_SLIDER0_CH_COUNT; i++)
                                              {
                                                      TS_AreaConfirmTimer[i] = WHEEL_SLIDER_BASELINE_UPDATE_TIME;
                                              }
                                      }
                              }                               
                      }
                      else if(WheelSliderState == WHEEL_SLIDER_TOUCH)
                      {               
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 16  

              #if (WHEEL_SLIDER_LONG_TOUCH_TIME_LIMIT > 0)
                              if(!TSWheelSlider_LongTouchLimitTimer)
                              {
                                      for(i = TS_BaseCh; i < TS_BaseCh + WHEEL_SLIDER0_CH_COUNT; i++)
                                      {
                                              TS_FirstAreaData[i] = TS_PostData[i];
                                              TS_BaseLineData[i]      = TS_PostData[i];
                                      }
                                      WheelSliderTouchFlag = 0;
                                      goto WHEEL_SLIDER_RELEASE;
                              }
              #endif
                              if(WheelSliderTouchFlag)
                              {
                                      if(Position == -1)      
                                      {
                                              WheelSliderTouchFlag = 0;
                                              TSWheelSlider_TouchConfirmTimer = WHEEL_SLIDER_TOUCH_RELEASE_CONFIRM_TIME;              
                                      }
                              }
                              else                                             
                              {
                                      if(Position == -1)      
                                      {
                                              if(!TSWheelSlider_TouchConfirmTimer)
                                              {
              WHEEL_SLIDER_RELEASE:
                                                      WheelSliderState = WHEEL_SLIDER_NO_TOUCH;       
                                                      WheelSliderCapRateFilter = 0;
                                                      WheelSliderPosition = -1;
                                                      for(i = TS_BaseCh; i < TS_BaseCh + WHEEL_SLIDER0_CH_COUNT; i++)
                                                      {
                                                              TS_AreaConfirmTimer[i] = WHEEL_SLIDER_BASELINE_UPDATE_TIME;
                                                      }
                                              }
                                      }
                                      else
                                      {
                                              WheelSliderTouchFlag = 1;                               
                                      }
                              }               
                      }               
                      if(WheelSliderState == WHEEL_SLIDER_TOUCH)
                      {
                              if(Position != -1)
                              {
                                      WheelSliderPosition = Position;
                              }       
              #if PRINT_WHEEL_SLIDER_POSITION_EN
                              TK_Debug_UartPutChar(WheelSliderPosition/100+0x30);             
                              TK_Debug_UartPutChar((WheelSliderPosition%100)/10+0x30);                
                              TK_Debug_UartPutChar((WheelSliderPosition%10)+0x30);    
              
                              TK_Debug_UartPutChar('\r');     
                              TK_Debug_UartPutChar('\n');     
              #endif
              #if PRINT_WHEEL_SLIDER_RATE_EN
                              {
                                      unsigned char DeltaRate;
                                      DeltaRate = WheelSliderCapRateFilter/4;
                                      TK_Debug_UartPutChar(WheelSliderMaxIdx + 0x30); 
                                      TK_Debug_UartPutChar(' ');
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 17  

                                              
                                      TK_Debug_UartPutChar(DeltaRate/100+0x30);               
                                      TK_Debug_UartPutChar((DeltaRate%100)/10+0x30);          
                                      TK_Debug_UartPutChar((DeltaRate%10)+0x30);      
                                      TK_Debug_UartPutChar('\r');     
                                      TK_Debug_UartPutChar('\n');                                     
                              }
              #endif
                      }
                      else
                      {
                              WheelSliderPosition = -1;       
                      }
              
                      if(WheelSliderPosition != -1)
                      {
                              ActiveTouchType = 2;
                      }
                      else
                      {
                              ActiveTouchType = 0;
                      }
              }
              #endif  
1001          void TS_init(void)
1002          {
1003   1              unsigned char i,ch_idx;
1004   1      #if (DEBUG)
                      Debug_init();
              #endif
1007   1      
1008   1              TS_Cnt          = OPENED_TS_COUNT;
1009   1              ch_idx = 0;
1010   1              for(i = 0;i < OPENED_TS_COUNT; i++)
1011   1              {
1012   2      #if (SUPPORT_KEY && SUPPORT_WHEEL_SLIDER)
                              if(i < KEY_CH_COUNT)
                              {
                                      TS_CH[ch_idx++] = TS_KEY_CH_INFO_SEQ[i][0];
                              }
                              else
                              {
                                      TS_CH[ch_idx++] = TS_WHEEL_SLIDER_CH_SEQ[i-KEY_CH_COUNT];
                              }
              #elif SUPPORT_KEY
1022   2                      TS_CH[ch_idx++] = TS_KEY_CH_INFO_SEQ[i][0];
1023   2      #elif SUPPORT_WHEEL_SLIDER
                              TS_CH[ch_idx++] = TS_WHEEL_SLIDER_CH_SEQ[i];
              #endif
1026   2              }
1027   1              
1028   1      #if (RTC_CLK_SELECT == IRCL)
1029   1              CKCON |= ILCKE;
1030   1              CKSEL |= RTCKS(1);
1031   1      #elif (RTC_CLK_SELECT == XOSCL) 
                      CKCON |= XLCKE;
                      while(!(CKCON & XLSTA));
              #endif
1035   1      
1036   1              RTCON = RTCE(1) | MSE(1) | HSE(1) | SCE(0) | MCE(0) | HCE(0);
1037   1              RTMSS = 0;
1038   1              
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 18  

1039   1              INT8EN = 1;                     
1040   1              
1041   1              TS_IO_init();
1042   1              
1043   1              
1044   1              TKCFG = TKDIV(TKDIV_VAL)|TKTMS(TKTMS_VAL);              
1045   1      #if (TK_CHARGE_REF_SELECT == SOURCE_VDD)
                      TKCON = TKST(0)|TKIE(1)|TMEN(0)|TWKE(0)|VRS(VRS_VAL);
                      TKPWC = TKPC(TK_PC_VAL)|VDS(0)|VIRS(0)|TKPWS(0)|TKCVS(0);               
              #elif (TK_CHARGE_REF_SELECT == SOURCE_INNER) 
1049   1              TKCON = TKST(0)|TKIE(1)|TMEN(0)|TWKE(0)|VRS(0);
1050   1              TKPWC = TKPC(TK_PC_VAL)|VDS(VDS_VAL)|VIRS(VIRS_VAL)|TKPWS(1)|TKCVS(1);          
1051   1      #endif
1052   1              
1053   1              INT3EN = 1; 
1054   1              
1055   1              TS_CycleScanDoneFlag = 0;
1056   1      #if SUPPORT_KEY
1057   1              KeysFlagSN = 0;
1058   1              PreKeysFlagSN = 0;
1059   1      #endif  
1060   1              ActiveTouchType = 0;
1061   1      #if SUPPORT_KEY
1062   1      #if SUPPORT_COVER_PANAL_AFTER_POWERON
                      PanalCoverJudgeFlag = 0;
              #endif
1065   1      #endif
1066   1      #if SUPPORT_TOUCH_SLEEP_MODE
                      EnterStopScanTimer = ENTER_STOP_MODE_TIME;
                TS_SleepEn = 1;
                      TS_SleepMode = 0;
              #endif
1071   1      #if SUPPORT_WHEEL_SLIDER
                      W_S_RefChSet = 0;
              
                      WheelSliderState = WHEEL_SLIDER_NO_TOUCH;
                      WheelSliderTouchFlag = 0;
                      WheelSliderPosition = -1;               
                      WheelSliderCapRateFilter = 0;
              #endif
1079   1              TS_State = TS_INIT;
1080   1              TS_Init_Step = 0;
1081   1      #if SUPPORT_KEY
1082   1      #if ANTI_SPEAKER_EN     
                      RefChDataTimer = 0;
              #endif
1085   1      #endif
1086   1              MainLoopCnt1 = MainLoopCnt2 = 0;
1087   1      #if SUPPORT_KEY 
1088   1      #if GENERATE_TS_KEY_EN
1089   1              TK_State = TK_STATE_RELEASE;
1090   1              TS_Key = 0;
1091   1      #endif
1092   1      #endif
1093   1      }
1094          
1095          void TS_Action(void)
1096          {       
1097   1              switch(TS_State)
1098   1              {
1099   2                      case TS_INIT:
1100   2                              TS_RunInit();                   
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 19  

1101   2                              break;
1102   2                      case TS_DEAL:           
1103   2                              if(TS_CycleScanDoneFlag)
1104   2                              {                       
1105   3                                      TS_CycleScanDoneFlag = 0;               
1106   3                                      MainLoopCnt1 = MainLoopCnt2 + 1;
1107   3      #if SUPPORT_KEY
1108   3      #if ANTI_SPEAKER_EN
                                              TS_RefChCheck();
              #endif
1111   3      #endif
1112   3                                      TS_DataFiltering();
1113   3                                      TS_StableFlag = 1;
1114   3      #if SUPPORT_KEY 
1115   3                                      if(ActiveTouchType != 2)
1116   3                                      {
1117   4                                              TSKey_DataDeal();       
1118   4                                      }
1119   3      #endif
1120   3      #if (DEBUG)
                                              Debug_ParamLoad();
              #endif          
1123   3      #if SUPPORT_WHEEL_SLIDER
                                              if(ActiveTouchType != 1)
                                              {
                                                      TS_WheelSliderDeal();
                                              }
              #endif                          
1129   3      #if SUPPORT_TOUCH_SLEEP_MODE
                                              if(!TS_StableFlag || !TS_SleepEn || (PCON & BIT2))      // ÔÚ·ÂÕæÄ£Ê½²»½øÈëSTOPÄ£Ê½
                                              {
                                                      EnterStopScanTimer = ENTER_STOP_MODE_TIME;
                                              }                       
                                              if(!EnterStopScanTimer&&TS_SleepEn)
                                              {
              #if ENTER_SLEEP_PRINT_EN
                                                      TK_Debug_UartPutChar('s');      
                                                      TK_Debug_UartPutChar('l');      
                                                      TK_Debug_UartPutChar('e');      
                                                      TK_Debug_UartPutChar('e');      
                                                      TK_Debug_UartPutChar('p');      
                                                      TK_Debug_UartPutChar('\r');     
                                                      TK_Debug_UartPutChar('\n');             
                                                      Delay_ms(1);
              #endif
                                                      TS_EnterSleepMode();            
              #if ENTER_SLEEP_PRINT_EN                                        
                                                      TK_Debug_UartPutChar('e');      
                                                      TK_Debug_UartPutChar('x');      
                                                      TK_Debug_UartPutChar('i');      
                                                      TK_Debug_UartPutChar('t');      
                                                      TK_Debug_UartPutChar('\r');     
                                                      TK_Debug_UartPutChar('\n');             
              #endif
                                              }
              #endif                                                                          
1157   3                              }
1158   2                              if(TS_HalfSecCnt >= 5)
1159   2                              {
1160   3                                      TKCON = 0;
1161   3                                      TKIF = 0x3F;
1162   3                                      TS_init();
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 20  

1163   3                              }
1164   2                              break;
1165   2                      default:
1166   2                              break;
1167   2              }
1168   1      
1169   1      #if SUPPORT_KEY 
1170   1      #if GENERATE_TS_KEY_EN
1171   1              TS_GetKey();
1172   1      #endif
1173   1      #endif
1174   1      }
1175          #if SUPPORT_TOUCH_SLEEP_MODE
              void TS_SleepScanStart(void)
              {       
                      unsigned char i;        
                      for(i = 0; i < 6; i++)                                  
                      {
                              INDEX = i;
                              if(TS_Index + i < TS_Cnt)
                              {
                                      TKCHS = MPOL(0) | NPOL(1) | TKCHS((TS_CH[TS_Index+i])+1); 
                              }
                              else
                              {
                                      TKCHS = 0; 
                              }
                      }
                      TKCON |= TKST(1);       
              }
              void TS_EnterSleepMode(void)
              {
              //Ê¡µçÄ£Ê½²ÎÊýÅäÖÃ
                      #define STOP_TKDIV_VAL                  0
                      #define STOP_TKTMS_VAL                  15              //·ÅµçÊ±¼ä
                      #define STOP_VRS_VAL                            7                       //±È½ÏÆ÷ãÐÖµ    
                      unsigned char TS_SampleComplete = 0,i;
                      unsigned int xdata WakeUp_PThdVal[OPENED_TS_COUNT];
                      unsigned int xdata WakeUp_NThdVal[OPENED_TS_COUNT];     
                      WORD_UNION TS_Data;
                      
                      Sys_Clk_Set_TFRC();
              #if (SYSCLK_SRC == PLL)
                      PLLCON = 0;
              #endif  
                      
                      TKCON = 0;
                      TKIF = 0x3F;
                      
                      TS_SleepMode = 1;
                      
                      RTCON &=  ~(MSE(1) | HSE(1));
                      RTCIF = RTC_MF | RTC_HF;        
                      
                      TKCON = (TKCON&0xF8) | VRS(STOP_VRS_VAL);
                      TKCON &= ~TKIE(1);
                      TKCFG = TKDIV(STOP_TKDIV_VAL)|TKTMS(STOP_TKTMS_VAL);            
              
              #if (OPENED_TS_COUNT%6 == 0)
                      TKMTS = (SLEEP_MODE_SCAN_INTERVAL_TIME*6)/(OPENED_TS_COUNT);
              #else
                      TKMTS = (SLEEP_MODE_SCAN_INTERVAL_TIME)/((OPENED_TS_COUNT/6)+1);
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 21  

              #endif
                      
                      TKPWC = TKPC(1)|VDS(0)|VIRS(0)|TKPWS(0)|TKCVS(0);               //Ê¡µçÉèÎªVDD³äµç
                      
              #ifdef LVD_RST_ENABLE
                      LVDCON = 0;     
              #endif          
                      I2CCON = 0;
                      CKCON = 0;
                      MECON |= BIT6;  
                      PWCON = (PWCON&0xF0)|0x07;      
              
                      TS_Index = 0;
                      TS_SleepScanStart();
                      WDFLG = 0xA5;
                      
                      RTCON |= HSE(1);
                      
                      while(1)
                      {
                              if(TS_SampleComplete)
                              {
                                      CKCON &= ~TFCKE;                
              #if (RTC_CLK_SELECT == IRCL)
                                      CKSEL = (CKSEL&0xF8) | CKSEL_IRCL;      //ÏµÍ³Ê±ÖÓÇÐ»»µ½IRCL    
              #elif (RTC_CLK_SELECT == XOSCL) 
                                      CKSEL = (CKSEL&0xF8) | CKSEL_XOSCL;     //ÇÐ»»ÏµÍ³Ê±ÖÓµ½XOSCL   
              #endif  
                                      EA = 0;
                                      PCON = (PCON&0x84) | 0x02;
                                      _nop_();
                                      _nop_();
                                      _nop_();
                                      CKCON |= TFCKE;                                                                                                 //Ê¹ÄÜTFRCÊ±ÖÓ
                                      CKSEL = (CKSEL&0xF8) | CKSEL_TFRC;                      //ÇÐ»»ÏµÍ³Ê±ÖÓµ½TFRC            
                                      EA = 1;
                              }
                              if(TS_HalfSecCnt >= 5)
                              {
                                      break;
                              }
                              if(TKIF != 0)
                              {
                                      if(TS_HalfSecCnt) TS_HalfSecCnt--;
                                      for(i = 0; i < 6; i++)
                                      {
                                              if(TKIF & (1<<i))
                                              {
                                                      TKIF = (1<<i);  
                                                      INDEX = i;
                                                      TS_Data.bVal[0] = TKMSH;
                                                      TS_Data.bVal[1] = TKMSL;
              
                                                      if(TS_SampleComplete == 0)
                                                      {
                                                              WakeUp_PThdVal[TS_Index+i] = TS_Data.wVal - SLEEP_TOUTH_THD;
                                                              WakeUp_NThdVal[TS_Index+i] = TS_Data.wVal + SLEEP_TOUTH_THD;
                                                      }
                                                      else 
                                                      {
                                                              if((TS_Data.wVal <= WakeUp_PThdVal[TS_Index+i])||(TS_Data.wVal >= WakeUp_NThdVal[TS_Index+i]))
                                                              {
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 22  

                                                                      goto SLEEP_EXIT;                        
                                                              }
                                                      }
                                              }
                                      }
                                      if(TS_Index+6 < TS_Cnt)
                                      {
                                              TS_Index += 6;
                                      }
                                      else 
                                      {
                                              TS_Index = 0;
                                              if(TS_SampleComplete == 0)
                                              {
                                                      TS_SampleComplete = 1;                          
                                                      TKCON |= TMEN(1);                                       
                                              }
                                      }
                                      TS_SleepScanStart();    
                                      WDFLG = 0xA5;
                              }
                      }
              SLEEP_EXIT:
                      TKCON = 0;
                      TKIF = 0x3F;
                      PWCON = (PWCON&0xF0)|0x0D;      
              #if (SYSCLK_SRC == PLL)
                      Sys_Clk_Set_PLL(PLL_Multiple);
              #elif (SYSCLK_SRC == IRCH)      
                      Sys_Clk_Set_IRCH();
              #endif
              
                      TKCFG = TKDIV(TKDIV_VAL)|TKTMS(TKTMS_VAL);              
              #if (TK_CHARGE_REF_SELECT == SOURCE_VDD)
                      TKCON = TKST(0)|TKIE(1)|TMEN(0)|TWKE(0)|VRS(VRS_VAL);
                      TKPWC = TKPC(TK_PC_VAL)|VDS(0)|VIRS(0)|TKPWS(0)|TKCVS(0);               
              #elif (TK_CHARGE_REF_SELECT == SOURCE_INNER) 
                      TKCON = TKST(0)|TKIE(1)|TMEN(0)|TWKE(0)|VRS(0);
                      TKPWC = TKPC(TK_PC_VAL)|VDS(VDS_VAL)|VIRS(VIRS_VAL)|TKPWS(1)|TKCVS(1);          
              #endif
              
                      RTCON |= HSE(1)|MSE(1);
                      TS_Index = 0;
                      TS_ScanStart();
                      EnterStopScanTimer = ENTER_STOP_MODE_TIME;
                      TS_SleepMode = 0;
              #ifdef LVD_RST_ENABLE
                      LVDCON = 0xc1;  //ÉèÖÃLVD¸´Î»µçÑ¹Îª2V
              #endif                                                  
              }
              #endif
1338          /*********************************************************************************************************
             -************/
1339          #if SUPPORT_KEY 
1340          #if GENERATE_TS_KEY_EN
1341          #if GENERATE_DOUBLE_KEY_EN
              typedef struct 
              {       
                      unsigned char   TogKeyNum;
                      unsigned char   TogKeyList[2];
              }
              T_TogKeyInfo;
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 23  

              #endif
1349          code unsigned char TS_KEY_TAB[]=
1350          {
1351                  K1,K2,K3,K4,K5,K6,K7,K8,K9,K10,K11,K12,K13,K14,K15,K16,K17,K18,K19,K20
1352          };
1353          #if GENERATE_DOUBLE_KEY_EN
              void TS_GetTogKeyInfor(T_TogKeyInfo *pKeyInfo)
              {
                      unsigned char i,index;
                      pKeyInfo->TogKeyNum = 0;
                      index = 0;
                      for(i = 0; i < KEY_CH_COUNT; i++)
                      {
                              if(KeysFlagSN & MASK_TAB[i])
                              {
                                      pKeyInfo->TogKeyNum++;
                                      
                                      if(pKeyInfo->TogKeyNum <= 2)
                                      {
                                              pKeyInfo->TogKeyList[index++] = TS_KEY_TAB[i];
                                      }
                              }
                      }
              }
              #endif
1373          #if PRINT_TS_KEY_EN
              void Hex2CharPrint(unsigned int integar)
              {
                      unsigned char CharBuf[4];
                      unsigned char i, temp;
                      for(i = 0; i < 4; i++)
                      {
                              temp = (unsigned char)(integar&0x0F);
                              if(temp >= 0x0A)
                              {
                                      CharBuf[i] = (temp - 0x0A) + 'A';
                              }
                              else
                              {
                                      CharBuf[i] = temp + '0';
                              }
                              integar >>= 4;
                      }
                      TK_Debug_UartPutChar('0');      
                      TK_Debug_UartPutChar('x');      
                      TK_Debug_UartPutChar(CharBuf[2]);
                      TK_Debug_UartPutChar(CharBuf[1]);
                      TK_Debug_UartPutChar(CharBuf[0]);
              }
              #endif
1398          void TS_GetKey(void)
1399          {
1400   1              static unsigned int KeyBak;     
1401   1              static bit LongFlag;
1402   1      #if GENERATE_DOUBLE_KEY_EN
                      T_TogKeyInfo KeyInfo;
                      TS_GetTogKeyInfor(&KeyInfo);
              #else
1406   1              static unsigned char KeyidxBak;
1407   1              unsigned char i;
1408   1      #endif
1409   1              TS_Key = 0;     
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 24  

1410   1              if(TK_State == TK_STATE_RELEASE)
1411   1              {
1412   2      #if GENERATE_DOUBLE_KEY_EN
                              if(KeyInfo.TogKeyNum != 0)
                              {                       
                                      if(KeyInfo.TogKeyNum == 1)
                                      {
                                              KeyBak = (unsigned int)KeyInfo.TogKeyList[0];
                                              TK_State = TK_STATE_SINGLE_KEY_PRESS;                           
                                      }
                                      else if(KeyInfo.TogKeyNum == 2)
                                      {
                                              KeyBak = ((unsigned int)KeyInfo.TogKeyList[0]<<5)|(unsigned int)KeyInfo.TogKeyList[1];
                                              TK_State = TK_STATE_DOUBLE_KEY_PRESS;
                                      }
                                      TS_Key = KeyBak;
                                      LongFlag = 0;
                                      TS_LongKeyTimer = TS_LONG_START_TIME;
                              }
              #else
1430   2                      if(KeysFlagSN != 0)
1431   2                      {
1432   3                              for(i = 0; i < KEY_CH_COUNT; i++)
1433   3                              {
1434   4                                      if(KeysFlagSN & MASK_TAB[i])
1435   4                                      {
1436   5                                              KeyidxBak = i;
1437   5                                              KeyBak = TS_KEY_TAB[i];
1438   5                                              break;
1439   5                                      }               
1440   4                              }                               
1441   3                              TS_Key = KeyBak;
1442   3                              LongFlag = 0;
1443   3                              TS_LongKeyTimer = TS_LONG_START_TIME;
1444   3                              TK_State = TK_STATE_SINGLE_KEY_PRESS;           
1445   3                      }
1446   2      #endif
1447   2              }
1448   1              else if(TK_State == TK_STATE_SINGLE_KEY_PRESS)
1449   1              {
1450   2      #if GENERATE_DOUBLE_KEY_EN      
                              if(KeyInfo.TogKeyNum == 1)
                              {
                                      if(KeyBak == (unsigned int)KeyInfo.TogKeyList[0])
                                      {
                                              if(!TS_LongKeyTimer)
                                              {
                                                      if(!LongFlag)
                                                      {
                                                              LongFlag = 1;
                                                              TS_Key = KeyBak | KEY_LONG_START;
                                                      }
                                                      else
                                                      {
                                                              TS_Key = KeyBak | KEY_LONG;
                                                      }
                                                      TS_LongKeyTimer = TS_LONG_TIME;
                                              }                               
                                      }
                                      else 
                                      {
                                              if(!LongFlag)
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 25  

                                              {
                                                      TS_Key = KeyBak | KEY_BREAK;
                                              }
                                              else
                                              {
                                                      TS_Key = KeyBak | KEY_LONG_BREAK;
                                              }
                                              TK_State = TK_STATE_RELEASE;
                                      }
                              }
                              else if(KeyInfo.TogKeyNum == 2)
                              {
                                      KeyBak = ((unsigned int)KeyInfo.TogKeyList[0]<<5) | (unsigned int)KeyInfo.TogKeyList[1];
                                      TK_State = TK_STATE_DOUBLE_KEY_PRESS;
                                      TS_Key = KeyBak;
                                      LongFlag = 0;
                                      TS_LongKeyTimer = TS_LONG_START_TIME;
                              }
                              else if(KeyInfo.TogKeyNum == 0)
                              {
                                      if(!LongFlag)
                                      {
                                              TS_Key = KeyBak | KEY_BREAK;
                                      }
                                      else
                                      {
                                              TS_Key = KeyBak | KEY_LONG_BREAK;
                                      }
                                      TK_State = TK_STATE_RELEASE;
                              }
              #else
1503   2                      if(KeysFlagSN & MASK_TAB[KeyidxBak])
1504   2                      {
1505   3                                      if(!TS_LongKeyTimer)
1506   3                                      {
1507   4                                              if(!LongFlag)
1508   4                                              {
1509   5                                                      LongFlag = 1;
1510   5                                                      TS_Key = KeyBak | KEY_LONG_START;
1511   5                                              }
1512   4                                              else
1513   4                                              {
1514   5                                                      TS_Key = KeyBak | KEY_LONG;
1515   5                                              }
1516   4                                              TS_LongKeyTimer = TS_LONG_TIME;
1517   4                                      }                                       
1518   3                      }
1519   2                      else
1520   2                      {
1521   3                              if(!LongFlag)
1522   3                              {
1523   4                                      TS_Key = KeyBak | KEY_BREAK;
1524   4                              }
1525   3                              else
1526   3                              {
1527   4                                      TS_Key = KeyBak | KEY_LONG_BREAK;
1528   4                              }
1529   3                              TK_State = TK_STATE_RELEASE;                    
1530   3                      }
1531   2      #endif
1532   2              }
1533   1      #if GENERATE_DOUBLE_KEY_EN      
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 26  

                      else if(TK_State == TK_STATE_DOUBLE_KEY_PRESS)
                      {
                              if(KeyInfo.TogKeyNum == 2)
                              {
                                      if(KeyBak == ((unsigned int)KeyInfo.TogKeyList[0]<<5)|(unsigned int)KeyInfo.TogKeyList[1])
                                      {
                                              if(!TS_LongKeyTimer)
                                              {
                                                      if(!LongFlag)
                                                      {
                                                              LongFlag = 1;
                                                              TS_Key = KeyBak | KEY_LONG_START;
                                                      }
                                                      else
                                                      {
                                                              TS_Key = KeyBak | KEY_LONG;
                                                      }
                                                      TS_LongKeyTimer = TS_LONG_TIME;
                                              }                                       
                                      }
                              }
                              else if(KeyInfo.TogKeyNum == 0)
                              {
                                      if(!LongFlag)
                                      {
                                              TS_Key = KeyBak | KEY_BREAK;
                                      }
                                      else
                                      {
                                              TS_Key = KeyBak | KEY_LONG_BREAK;
                                      }
                                      TK_State = TK_STATE_RELEASE;            
                              }
                      }
              #endif
1569   1      #if PRINT_TS_KEY_EN
                      if(TS_Key != 0)
                      {
                              if((TS_Key & 0xFF00) == 0)
                              {
              #if GENERATE_DOUBLE_KEY_EN      
                                      if(TS_Key > 0x1F)
                                      {
                                              TK_Debug_UartPutChar('d');      
                                              TK_Debug_UartPutChar('o');      
                                              TK_Debug_UartPutChar('u');      
                                              TK_Debug_UartPutChar('b');      
                                              TK_Debug_UartPutChar('l');      
                                              TK_Debug_UartPutChar('e');                      
                                      }
                                      else
                                      {
                                              TK_Debug_UartPutChar('s');      
                                              TK_Debug_UartPutChar('i');      
                                              TK_Debug_UartPutChar('n');      
                                              TK_Debug_UartPutChar('g');      
                                              TK_Debug_UartPutChar('l');      
                                              TK_Debug_UartPutChar('e');              
                                      }
                                      TK_Debug_UartPutChar(' ');      
              #endif
                                      TK_Debug_UartPutChar('k');      
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 27  

                                      TK_Debug_UartPutChar('e');      
                                      TK_Debug_UartPutChar('y');      
                                      TK_Debug_UartPutChar(' ');      
                                      TK_Debug_UartPutChar('=');      
                                      TK_Debug_UartPutChar(' ');      
                                      Hex2CharPrint(TS_Key);
                                      TK_Debug_UartPutChar('\r');     
                                      TK_Debug_UartPutChar('\n');     
                              }
                              else if(TS_Key & KEY_BREAK)
                              {
                                      TK_Debug_UartPutChar('k');      
                                      TK_Debug_UartPutChar('e');      
                                      TK_Debug_UartPutChar('y');      
                                      TK_Debug_UartPutChar(' ');      
                                      TK_Debug_UartPutChar('u');      
                                      TK_Debug_UartPutChar('p');      
                                      TK_Debug_UartPutChar('\r');     
                                      TK_Debug_UartPutChar('\n');                             
                              }
                              else if(TS_Key & KEY_LONG_START)
                              {
                                      TK_Debug_UartPutChar('l');      
                                      TK_Debug_UartPutChar('o');      
                                      TK_Debug_UartPutChar('n');      
                                      TK_Debug_UartPutChar('g');      
                                      TK_Debug_UartPutChar(' ');      
                                      TK_Debug_UartPutChar('s');      
                                      TK_Debug_UartPutChar('t');      
                                      TK_Debug_UartPutChar('a');      
                                      TK_Debug_UartPutChar('r');      
                                      TK_Debug_UartPutChar('t');      
                                      TK_Debug_UartPutChar('\r');     
                                      TK_Debug_UartPutChar('\n');                     
                              }
                              else if(TS_Key & KEY_LONG)
                              {
                                      TK_Debug_UartPutChar('l');      
                                      TK_Debug_UartPutChar('o');      
                                      TK_Debug_UartPutChar('n');      
                                      TK_Debug_UartPutChar('g');      
                                      TK_Debug_UartPutChar('\r');     
                                      TK_Debug_UartPutChar('\n');                     
                              }
                      }
              #endif
1642   1      }
1643          #endif
1644          #endif
1645          /*********************************************************************************************************
             -************/
1646          
1647          /*********************************************************************************************************
             -************/
1648          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1868    ----
   CONSTANT SIZE    =     56    ----
   XDATA SIZE       =    202    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.02   TS_API                                                                05/12/2022 13:56:08 PAGE 28  

   DATA SIZE        =     13      37
   IDATA SIZE       =     10    ----
   BIT SIZE         =      3    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
